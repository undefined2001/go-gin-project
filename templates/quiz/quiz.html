<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCQ Quiz System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        .pulse-error {
            animation: pulseRed 1s;
        }

        @keyframes pulseRed {

            0%,
            100% {
                background-color: transparent;
            }

            50% {
                background-color: rgba(254, 202, 202, 0.5);
            }
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }

            80%,
            100% {
                content: '';
            }
        }

        /* Disable selection for MCQ options to prevent accidental selection */
        .option-card {
            user-select: none;
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
            background: linear-gradient(145deg, #ffffff, #f5f5f5);
            border: 1px solid #e0e0e0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Add a subtle hover effect for better UX */
        .option-card:hover:not(.selected) {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
            background: linear-gradient(145deg, #f8f9fa, #ffffff);
            border-color: #d0d0d0;
        }

        /* Selected state styling */
        .option-card.selected {
            background: linear-gradient(145deg, #e6f7ff, #d1edff);
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
            transform: scale(1.02);
        }

        /* Focus state for keyboard navigation */
        .option-card:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.3);
        }

        /* Add a subtle indicator for each option */
        .option-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: #e0e0e0;
            transition: all 0.3s ease;
        }

        /* Change indicator color on hover */
        .option-card:hover::before {
            background: #ccc;
        }

        /* Change indicator for selected option */
        .option-card.selected::before {
            background: #1890ff;
            width: 6px;
        }

        /* Add a ripple effect when clicked */
        .option-card:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        /* Disabled state */
        .option-card.disabled {
            opacity: 0.6;
            pointer-events: none;
            background: #f5f5f5;
            border-color: #eaeaea;
        }

        /* Incorrect answer styling */
        .option-card.incorrect {
            background: linear-gradient(145deg, #fff1f0, #fff7f6);
            border-color: #ff4d4f;
        }

        /* Correct answer styling */
        .option-card.correct {
            background: linear-gradient(145deg, #f6ffed, #efffdc);
            border-color: #52c41a;
        }

        /* Update circle styling for selected state */
        .option-card .circle {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .option-card.selected .circle {
            border-color: #1890ff;
            background-color: #1890ff;
        }

        .option-card .circle .inner-circle {
            width: 10px;
            height: 10px;
            background-color: transparent;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .option-card.selected .circle .inner-circle {
            background-color: #ffffff;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-700 mb-2">MCQ Quiz System</h1>
            <p class="text-gray-600">Select the correct answer for each question</p>
        </header>

        <!-- Loading Screen -->
        <div id="loading-screen" class="flex flex-col items-center justify-center py-20 fade-in">
            <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-lg text-gray-700 loading-dots">Loading quiz</p>
            <!-- Data from API: Loading state while fetching quiz data -->
        </div>

        <!-- Error Screen -->
        <div id="error-screen" class="rounded-lg bg-red-100 p-8 text-center hidden fade-in">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 class="text-2xl font-bold text-red-700 mb-2">Oops! Something went wrong</h2>
            <p id="error-message" class="text-red-600 mb-6">Unable to load quiz data. Please check your connection and
                try again.</p>
            <!-- Data from API: Error message if quiz data fails to load -->
            <button id="retry-button"
                class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded-lg transition duration-200">
                Try Again
            </button>
        </div>

        <!-- Quiz Content -->
        <div id="quiz-content" class="hidden fade-in">
            <!-- Quiz Info -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                    <h2 id="quiz-title" class="text-xl font-semibold text-gray-800">Quiz Title</h2>
                    <p id="quiz-description" class="text-gray-600 text-sm">Quiz description goes here</p>
                    <!-- Data from API: Quiz title and description -->
                </div>
                <div class="flex items-center mt-2 md:mt-0">
                    <span id="time-display"
                        class="hidden bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full font-medium">
                        <span id="minutes">00</span>:<span id="seconds">00</span>
                        <!-- Data from API: Quiz time limit -->
                    </span>
                </div>
            </div>

            <!-- Add the progress bar element to the DOM -->
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300"
                    style="width: 0%"></div>
            </div>

            <!-- Questions Container -->
            <div id="questions-container" class="space-y-6">
                <!-- Data from API: Quiz questions and options -->
            </div>

            <!-- Submit Button Panel -->
            <div id="submit-panel" class="bg-white rounded-lg shadow-md p-6 text-center">
                <p class="text-gray-600 mb-4">Make sure to answer all questions before submitting</p>
                <button id="submit-button"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Submit Quiz
                </button>
                <!-- Data from API: Submit quiz results -->
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden fade-in">
            <div class="bg-white rounded-lg shadow-md p-8 mb-6">
                <div class="text-center mb-8">
                    <div id="score-ring"
                        class="mx-auto w-32 h-32 rounded-full flex items-center justify-center border-8 border-indigo-500 mb-4">
                        <div>
                            <span id="score-percentage" class="block text-3xl font-bold text-indigo-700">0%</span>
                            <span class="text-gray-500">Score</span>
                            <!-- Data from API: Final quiz score -->
                        </div>
                    </div>
                    <h2 id="result-title" class="text-2xl font-bold text-gray-800 mb-2">Quiz Completed!</h2>
                    <p id="result-message" class="text-gray-600">You answered 0 out of 0 questions correctly.</p>
                    <!-- Data from API: Quiz results summary -->
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="text-center bg-gray-50 rounded-lg p-4">
                        <span id="total-questions" class="block text-2xl font-bold text-gray-700">0</span>
                        <span class="text-sm text-gray-500">Total Questions</span>
                        <!-- Data from API: Total number of questions -->
                    </div>
                    <div class="text-center bg-green-50 rounded-lg p-4">
                        <span id="correct-answers" class="block text-2xl font-bold text-green-600">0</span>
                        <span class="text-sm text-gray-500">Correct</span>
                        <!-- Data from API: Number of correct answers -->
                    </div>
                    <div class="text-center bg-red-50 rounded-lg p-4">
                        <span id="incorrect-answers" class="block text-2xl font-bold text-red-600">0</span>
                        <span class="text-sm text-gray-500">Incorrect</span>
                        <!-- Data from API: Number of incorrect answers -->
                    </div>
                    <div class="text-center bg-yellow-50 rounded-lg p-4">
                        <span id="unanswered-questions" class="block text-2xl font-bold text-yellow-600">0</span>
                        <span class="text-sm text-gray-500">Unanswered</span>
                        <!-- Data from API: Number of unanswered questions -->
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-4 justify-center">
                    <button id="review-button"
                        class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-medium py-2 px-6 rounded-lg transition duration-200">
                        Review Answers
                    </button>
                    <button id="retry-quiz-button"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded-lg transition duration-200">
                        Try Again
                    </button>
                    <button id="new-quiz-button"
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg transition duration-200">
                        New Quiz
                    </button>
                </div>
            </div>

            <!-- Review Section -->
            <div id="review-section" class="hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Review Your Answers</h3>
                <div id="review-container" class="space-y-6 mb-6">
                    <!-- Data from API: Review of user's answers -->
                </div>
                <button id="back-to-results"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded-lg transition duration-200">
                    Back to Results
                </button>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 id="confirmation-title" class="text-xl font-bold text-gray-800 mb-4">Submit Quiz</h3>
                <p id="confirmation-message" class="text-gray-600 mb-6">Are you sure you want to submit your answers?
                    You have 2 unanswered questions.</p>
                <!-- Data from API: Confirmation message based on unanswered questions -->
                <div class="flex justify-end gap-4">
                    <button id="cancel-button"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button id="confirm-button"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                        Confirm
                    </button>
                </div>
            </div>
        </div>

        <!-- Network Error Toast -->
        <div id="network-toast"
            class="fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg hidden z-50">
            Network error. Trying to reconnect...
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Constants and configuration
            const API_ENDPOINT = 'https://your-api-endpoint.com/api'; // Replace with your actual API endpoint
            const MAX_RETRIES = 3;
            const RETRY_DELAY = 2000; // 2 seconds
            const AUTOSAVE_INTERVAL = 30000; // 30 seconds
            const LOCAL_STORAGE_KEY = 'quiz_progress';

            // State management
            let quizData = null;
            let currentQuestionIndex = 0;
            let userAnswers = [];
            let quizStartTime = null;
            let timerInterval = null;
            let retryCount = 0;
            let confirmationAction = null;
            let autoSaveInterval = null;

            // DOM Elements - Cache them for performance
            const elements = {
                loadingScreen: document.getElementById('loading-screen'),
                errorScreen: document.getElementById('error-screen'),
                quizContent: document.getElementById('quiz-content'),
                resultsScreen: document.getElementById('results-screen'),
                retryButton: document.getElementById('retry-button'),
                submitButton: document.getElementById('submit-button'),
                submitPanel: document.getElementById('submit-panel'),
                questionCard: document.getElementById('question-card'),
                optionsContainer: document.getElementById('options-container'),
                questionNavigator: document.getElementById('question-navigator'),
                questionError: document.getElementById('question-error'),
                progressBar: document.getElementById('progress-bar'), // Ensure this element exists in the DOM
                timeDisplay: document.getElementById('time-display'),
                minutes: document.getElementById('minutes'),
                seconds: document.getElementById('seconds'),
                reviewButton: document.getElementById('review-button'),
                retryQuizButton: document.getElementById('retry-quiz-button'),
                newQuizButton: document.getElementById('new-quiz-button'),
                reviewSection: document.getElementById('review-section'),
                reviewContainer: document.getElementById('review-container'),
                backToResultsButton: document.getElementById('back-to-results'),
                confirmationModal: document.getElementById('confirmation-modal'),
                confirmationTitle: document.getElementById('confirmation-title'),
                confirmationMessage: document.getElementById('confirmation-message'),
                cancelButton: document.getElementById('cancel-button'),
                confirmButton: document.getElementById('confirm-button'),
                networkToast: document.getElementById('network-toast'),
                errorMessage: document.getElementById('error-message'),
                quizTitle: document.getElementById('quiz-title'),
                quizDescription: document.getElementById('quiz-description'),
                questionNumber: document.getElementById('question-number'),
                questionPoints: document.getElementById('question-points'),
                questionText: document.getElementById('question-text'),
                questionImage: document.getElementById('question-image'),
                questionImageContainer: document.getElementById('question-image-container'),
                scorePercentage: document.getElementById('score-percentage'),
                resultTitle: document.getElementById('result-title'),
                resultMessage: document.getElementById('result-message'),
                totalQuestions: document.getElementById('total-questions'),
                correctAnswers: document.getElementById('correct-answers'),
                incorrectAnswers: document.getElementById('incorrect-answers'),
                unansweredQuestions: document.getElementById('unanswered-questions')
            };

            // Add event listeners
            elements.retryButton.addEventListener('click', initQuiz);
            elements.submitButton.addEventListener('click', confirmSubmitQuiz);
            elements.reviewButton.addEventListener('click', showReviewSection);
            elements.backToResultsButton.addEventListener('click', hideReviewSection);
            elements.retryQuizButton.addEventListener('click', retryQuiz);
            elements.newQuizButton.addEventListener('click', initQuiz);
            elements.cancelButton.addEventListener('click', closeConfirmationModal);
            elements.confirmButton.addEventListener('click', handleConfirmationAction);

            // Add keyboard navigation
            document.addEventListener('keydown', handleKeyboardNavigation);

            // Handle beforeunload event
            window.addEventListener('beforeunload', (e) => {
                if (quizData && !elements.resultsScreen.classList.contains('hidden') && hasUnansweredQuestions()) {
                    const message = "You have unsaved quiz progress. Are you sure you want to leave?";
                    e.returnValue = message;
                    return message;
                }
            });

            // Handle offline/online events
            window.addEventListener('offline', handleOffline);
            window.addEventListener('online', handleOnline);

            // Initialize quiz on page load
            initQuiz();

            // Functions
            async function initQuiz() {
                resetQuizState();
                showLoadingScreen();

                try {
                    await fetchQuizData();
                    userAnswers = Array(quizData.questions.length).fill(null);
                    restoreQuizProgress();
                    if (quizData.timeLimit && quizData.timeLimit > 0) startQuizTimer(quizData.timeLimit);
                    quizStartTime = new Date();
                    startAutoSave();
                    populateQuizInfo();
                    renderQuestions(); // Render all questions in vertical sequence
                    hideLoadingScreen();
                    showQuizContent();
                } catch (error) {
                    console.error('Failed to initialize quiz:', error);
                    showErrorScreen('Failed to load quiz data. Please try again.');
                }
            }

            function resetQuizState() {
                currentQuestionIndex = 0;
                userAnswers = [];
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                    autoSaveInterval = null;
                }
                quizStartTime = null;
                retryCount = 0;

                // Hide all screens
                elements.loadingScreen.classList.add('hidden');
                elements.errorScreen.classList.add('hidden');
                elements.quizContent.classList.add('hidden');
                elements.resultsScreen.classList.add('hidden');
                elements.reviewSection.classList.add('hidden');
            }

            async function fetchQuizData() {
                try {
                    // const response = await fetch(`${API_ENDPOINT}/quizzes/random`);
                    // if (!response.ok) throw new Error('Failed to fetch quiz data');
                    // quizData = await response.json();

                    // MOCK DATA FOR TESTING:
                    // Uncomment the block below and comment out the fetch code above to use mock data during development.
                    await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network delay
                    quizData = {
                        id: "q123",
                        title: "Web Development Fundamentals",
                        description: "Test your knowledge of web development basics",
                        timeLimit: 600, // 10 minutes in seconds
                        questions: [
                            {
                                id: "q1",
                                text: "Which language is primarily used for styling web pages?",
                                points: 10,
                                options: [
                                    { id: "a", text: "HTML" },
                                    { id: "b", text: "CSS" },
                                    { id: "c", text: "JavaScript" },
                                    { id: "d", text: "PHP" }
                                ],
                                correctAnswer: "b",
                                hasImage: false
                            },
                            {
                                id: "q2",
                                text: "What does HTML stand for?",
                                points: 10,
                                options: [
                                    { id: "a", text: "Hyper Text Markup Language" },
                                    { id: "b", text: "Home Tool Markup Language" },
                                    { id: "c", text: "Hyperlinks and Text Markup Language" },
                                    { id: "d", text: "Hyper Text Makeup Language" }
                                ],
                                correctAnswer: "a",
                                hasImage: false
                            },
                            {
                                id: "q3",
                                text: "Which of these is NOT a JavaScript framework?",
                                points: 15,
                                options: [
                                    { id: "a", text: "React" },
                                    { id: "b", text: "Angular" },
                                    { id: "c", text: "Laravel" },
                                    { id: "d", text: "Vue" }
                                ],
                                correctAnswer: "c",
                                hasImage: false
                            }
                        ]
                    };

                    return quizData;
                } catch (error) {
                    console.error('Error fetching quiz data:', error);
                    // Show network error toast
                    showNetworkToast();

                    // Implement retry logic
                    if (retryCount < MAX_RETRIES) {
                        retryCount++;
                        console.log(`Retrying (${retryCount}/${MAX_RETRIES})...`);
                        await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
                        return fetchQuizData();
                    } else {
                        throw new Error('Failed to fetch quiz data after multiple attempts');
                    }
                }
            }

            function populateQuizInfo() {
                // Set quiz title and description
                elements.quizTitle.textContent = quizData.title || 'Quiz';
                elements.quizDescription.textContent = quizData.description || '';

                // Show timer if time limit exists
                if (quizData.timeLimit && quizData.timeLimit > 0) {
                    elements.timeDisplay.classList.remove('hidden');
                } else {
                    elements.timeDisplay.classList.add('hidden');
                }

                // Update progress bar
                updateProgressBar();
            }

            function renderQuestions() {
                const questionsContainer = document.getElementById('questions-container');
                questionsContainer.innerHTML = ''; // Clear any existing content

                quizData.questions.forEach((question, index) => {
                    const questionCard = document.createElement('div');
                    questionCard.className = 'bg-white rounded-lg shadow-md p-6';

                    questionCard.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full font-medium">Question ${index + 1} of ${quizData.questions.length}</span>
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full font-medium">${question.points} points</span>
                        </div>
                        <h3 class="text-xl font-medium text-gray-800 mb-4">${question.text}</h3>
                        ${question.hasImage ? `<div class="mb-4"><img src="${question.imageUrl}" alt="Question Image" class="rounded-lg max-w-full h-auto"></div>` : ''}
                        <div class="space-y-3">
                            ${question.options.map(option => `
                                <div class="option-card cursor-pointer"
                                    data-question-index="${index}" data-option-id="${option.id}">
                                    <div class="flex items-center">
                                        <div class="circle">
                                            <div class="inner-circle"></div>
                                        </div>
                                        <div class="ml-3 text-gray-800">${option.text}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    questionsContainer.appendChild(questionCard);
                });

                attachOptionCardListeners(); // Attach event listeners after rendering
            }

            function attachOptionCardListeners() {
                document.querySelectorAll('.option-card').forEach(optionCard => {
                    optionCard.addEventListener('click', () => {
                        const questionIndex = parseInt(optionCard.dataset.questionIndex, 10);
                        const optionId = optionCard.dataset.optionId;

                        // Update user answers
                        userAnswers[questionIndex] = optionId;

                        // Update UI to reflect the selected option
                        const options = optionCard.parentElement.querySelectorAll('.option-card');
                        options.forEach(opt => opt.classList.remove('selected'));
                        optionCard.classList.add('selected');

                        // Save progress
                        saveQuizProgress();
                    });
                });
            }

            function updateProgressBar() {
                if (!quizData || !quizData.questions || !elements.progressBar) return; // Add null check for progressBar

                // Calculate progress percentage
                const answeredQuestions = userAnswers.filter(answer => answer !== null).length;
                const progress = (answeredQuestions / quizData.questions.length) * 100;

                // Update progress bar width
                elements.progressBar.style.width = `${progress}%`;
            }

            function startQuizTimer(timeLimit) {
                // Clear any existing timer
                if (timerInterval) {
                    clearInterval(timerInterval);
                }

                // Set end time
                const endTime = new Date();
                endTime.setSeconds(endTime.getSeconds() + timeLimit);

                // Update timer display
                updateTimerDisplay(timeLimit);

                // Start interval to update timer every second
                timerInterval = setInterval(() => {
                    // Calculate remaining time
                    const now = new Date();
                    const remainingTime = Math.max(0, Math.floor((endTime - now) / 1000));

                    // Update timer display
                    updateTimerDisplay(remainingTime);

                    // Check if time is up
                    if (remainingTime <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;

                        // Auto-submit quiz
                        submitQuiz();
                    }
                }, 1000);
            }

            function updateTimerDisplay(timeInSeconds) {
                const minutesValue = Math.floor(timeInSeconds / 60);
                const secondsValue = timeInSeconds % 60;

                // Format with leading zeros
                elements.minutes.textContent = minutesValue.toString().padStart(2, '0');
                elements.seconds.textContent = secondsValue.toString().padStart(2, '0');

                // Change color when time is running low
                if (timeInSeconds <= 60) {
                    elements.timeDisplay.classList.remove('bg-indigo-100', 'text-indigo-800');
                    elements.timeDisplay.classList.add('bg-red-100', 'text-red-800');
                } else {
                    elements.timeDisplay.classList.remove('bg-red-100', 'text-red-800');
                    elements.timeDisplay.classList.add('bg-indigo-100', 'text-indigo-800');
                }
            }

            function startAutoSave() {
                // Clear any existing autosave interval
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                }

                // Start new autosave interval
                autoSaveInterval = setInterval(() => {
                    saveQuizProgress();
                }, AUTOSAVE_INTERVAL);
            }

            function saveQuizProgress() {
                if (!quizData) return;

                const progressData = {
                    quizId: quizData.id,
                    currentQuestionIndex,
                    userAnswers,
                    timestamp: new Date().getTime()
                };

                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(progressData));
            }

            function restoreQuizProgress() {
                const savedProgress = localStorage.getItem(LOCAL_STORAGE_KEY);

                if (savedProgress) {
                    try {
                        const progressData = JSON.parse(savedProgress);

                        // Only restore if it's the same quiz
                        if (progressData.quizId === quizData.id) {
                            currentQuestionIndex = progressData.currentQuestionIndex || 0;
                            userAnswers = progressData.userAnswers || Array(quizData.questions.length).fill(null);

                            // Update submit button state
                            updateSubmitButtonState();
                        }
                    } catch (error) {
                        console.error('Error restoring quiz progress:', error);
                        // Clear invalid saved data
                        localStorage.removeItem(LOCAL_STORAGE_KEY);
                    }
                }
            }

            function clearSavedProgress() {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
            }

            function updateSubmitButtonState() {
                if (!quizData) return;

                // Enable submit button if at least one question is answered
                const hasAnsweredQuestions = userAnswers.some(answer => answer !== null);
                elements.submitButton.disabled = !hasAnsweredQuestions;
            }

            function confirmSubmitQuiz() {
                if (!quizData) return;

                // Calculate unanswered questions
                const unansweredCount = userAnswers.filter(answer => answer === null).length;

                // Set confirmation modal content
                elements.confirmationTitle.textContent = 'Submit Quiz';
                elements.confirmationMessage.textContent = `Are you sure you want to submit your answers? You have ${unansweredCount} unanswered question${unansweredCount !== 1 ? 's' : ''}.`;

                // Set confirmation action
                confirmationAction = submitQuiz;

                // Show modal
                elements.confirmationModal.classList.remove('hidden');
            }

            function submitQuiz() {
                // Close confirmation modal if open
                closeConfirmationModal();

                // Stop timer if running
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }

                // Stop autosave
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                    autoSaveInterval = null;
                }

                // Calculate results
                calculateResults();

                // Clear saved progress
                clearSavedProgress();

                // Show results screen
                hideQuizContent();
                showResultsScreen();
            }

            function calculateResults() {
                if (!quizData) return;

                let correctCount = 0;
                let incorrectCount = 0;
                let unansweredCount = 0;

                quizData.questions.forEach((question, index) => {
                    const userAnswer = userAnswers[index];
                    const optionCards = document.querySelectorAll(`[data-question-index="${index}"]`);

                    if (userAnswer === null) {
                        unansweredCount++;
                    } else if (userAnswer === question.correctAnswer) {
                        correctCount++;
                        optionCards.forEach(card => {
                            if (card.dataset.optionId === userAnswer) {
                                card.classList.add('correct');
                            }
                        });
                    } else {
                        incorrectCount++;
                        optionCards.forEach(card => {
                            if (card.dataset.optionId === userAnswer) {
                                card.classList.add('incorrect');
                            }
                            if (card.dataset.optionId === question.correctAnswer) {
                                card.classList.add('correct');
                            }
                        });
                    }
                });

                // Update results display
                elements.correctAnswers.textContent = correctCount;
                elements.incorrectAnswers.textContent = incorrectCount;
                elements.unansweredQuestions.textContent = unansweredCount;
            }

            function retryQuiz() {
                // Reset user answers
                userAnswers = Array(quizData.questions.length).fill(null);

                // Reset current question index
                currentQuestionIndex = 0;

                // Restart timer if needed
                if (quizData.timeLimit && quizData.timeLimit > 0) {
                    startQuizTimer(quizData.timeLimit);
                }

                // Record new start time
                quizStartTime = new Date();

                // Restart autosave
                startAutoSave();

                // Render first question
                renderQuestion(0);

                // Update question navigator
                renderQuestionNavigator();

                // Update submit button state
                updateSubmitButtonState();

                // Show quiz content
                hideResultsScreen();
                showQuizContent();
            }

            function showReviewSection() {
                // Hide results summary
                document.querySelector('#results-screen > div:first-child').classList.add('hidden');

                // Show review section
                elements.reviewSection.classList.remove('hidden');

                // Render review content
                renderReviewContent();
            }

            function hideReviewSection() {
                // Show results summary
                document.querySelector('#results-screen > div:first-child').classList.remove('hidden');

                // Hide review section
                elements.reviewSection.classList.add('hidden');
            }

            function renderReviewContent() {
                // Clear previous content
                elements.reviewContainer.innerHTML = '';

                // Create review items for each question
                quizData.questions.forEach((question, index) => {
                    const userAnswer = userAnswers[index];
                    const isCorrect = userAnswer === question.correctAnswer;

                    const reviewItem = document.createElement('div');
                    reviewItem.className = `bg-white rounded-lg shadow-sm p-6 border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'
                        }`;

                    // Question header
                    const questionHeader = document.createElement('div');
                    questionHeader.className = 'flex justify-between items-center mb-4';
                    questionHeader.innerHTML = `
                <span class="font-medium text-gray-700">Question ${index + 1}</span>
                <span class="text-sm px-3 py-1 rounded-full ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">${isCorrect ? 'Correct' : 'Incorrect'}</span>
            `;

                    // Question text
                    const questionText = document.createElement('p');
                    questionText.className = 'text-gray-800 mb-4';
                    questionText.textContent = question.text;

                    // User answer
                    const userAnswerDiv = document.createElement('div');
                    userAnswerDiv.className = 'mb-2';
                    userAnswerDiv.innerHTML = `
                <span class="font-medium">Your answer:</span> 
                <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">
                    ${userAnswer ? getOptionText(question, userAnswer) : 'Not answered'}
                </span>
            `;

                    // Correct answer (if incorrect)
                    let correctAnswerDiv = '';
                    if (!isCorrect) {
                        correctAnswerDiv = `
                    <div class="mb-2">
                        <span class="font-medium">Correct answer:</span> 
                        <span class="text-green-600">
                            ${getOptionText(question, question.correctAnswer)}
                        </span>
                    </div>
                `;
                    }

                    // Explanation (if available)
                    let explanationDiv = '';
                    if (question.explanation) {
                        explanationDiv = `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <span class="font-medium">Explanation:</span> 
                        <span class="text-gray-700">${question.explanation}</span>
                    </div>
                `;
                    }

                    // Assemble the review item
                    reviewItem.innerHTML = `
                ${questionHeader.outerHTML}
                ${questionText.outerHTML}
                ${userAnswerDiv.outerHTML}
                ${correctAnswerDiv}
                ${explanationDiv}
            `;

                    elements.reviewContainer.appendChild(reviewItem);
                });
            }

            function getOptionText(question, optionId) {
                const option = question.options.find(opt => opt.id === optionId);
                return option ? option.text : 'Unknown option';
            }

            function handleConfirmationAction() {
                if (confirmationAction) {
                    confirmationAction();
                }
                closeConfirmationModal();
            }

            function closeConfirmationModal() {
                elements.confirmationModal.classList.add('hidden');
                confirmationAction = null;
            }

            function handleKeyboardNavigation(e) {
                // Only handle keyboard events when quiz content is visible
                if (elements.quizContent.classList.contains('hidden')) return;

                switch (e.key) {
                    case 'ArrowLeft':
                        if (!elements.prevButton.disabled) {
                            goToPreviousQuestion();
                        }
                        break;
                    case 'ArrowRight':
                    case ' ':
                        if (!elements.nextButton.disabled) {
                            goToNextQuestion();
                        }
                        break;
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                        // Select option by number (1-4)
                        const optionIndex = parseInt(e.key) - 1;
                        const question = quizData.questions[currentQuestionIndex];
                        if (optionIndex >= 0 && optionIndex < question.options.length) {
                            selectOption(question.options[optionIndex].id, currentQuestionIndex);
                        }
                        break;
                    default:
                        break;
                }
            }

            function hasUnansweredQuestions() {
                return userAnswers.some(answer => answer === null);
            }

            function handleOffline() {
                showNetworkToast();
            }

            function handleOnline() {
                hideNetworkToast();
            }

            function showNetworkToast() {
                elements.networkToast.classList.remove('hidden');
            }

            function hideNetworkToast() {
                elements.networkToast.classList.add('hidden');
            }

            function showLoadingScreen() {
                elements.loadingScreen.classList.remove('hidden');
            }

            function hideLoadingScreen() {
                elements.loadingScreen.classList.add('hidden');
            }

            function showErrorScreen(message) {
                elements.errorMessage.textContent = message;
                elements.errorScreen.classList.remove('hidden');
            }

            function hideErrorScreen() {
                elements.errorScreen.classList.add('hidden');
            }

            function showQuizContent() {
                elements.quizContent.classList.remove('hidden');
            }

            function hideQuizContent() {
                elements.quizContent.classList.add('hidden');
            }

            function showResultsScreen() {
                elements.resultsScreen.classList.remove('hidden');
            }

            function hideResultsScreen() {
                elements.resultsScreen.classList.add('hidden');
            }
        });
    </script>
</body>

</html>